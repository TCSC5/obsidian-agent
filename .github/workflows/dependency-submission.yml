name: Dependency submission (Python)

on:
  push:
    branches: [ main ]
    paths:
      - 'requirements.txt'
      - 'requirements/**.txt'
      - 'pyproject.toml'
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write   # required for dependency-graph snapshots

jobs:
  dependency-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        # actions/checkout v5.0.0 (pinned)
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3

      - name: Set up Python
        # actions/setup-python v6.0.0 (pinned)
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: '3.11'

      - name: Install dependencies and generate manifest
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # tool to inspect the dep tree
          python -m pip install pipdeptree
          pipdeptree --warn silence --json-tree > deps.json

      - name: Convert pipdeptree to GitHub snapshot format
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python - << 'EOF'
          import json, os
          from datetime import datetime, timezone

          # 1) load pipdeptree output
          with open("deps.json", "r") as f:
              raw = json.load(f)

          resolved = {}
          skipped = 0

          def add_node(node, direct=True):
              # skip weird entries
              if not isinstance(node, dict):
                  return False

              pkg = node.get("package")
              if not pkg:
                  return False

              name = (
                  pkg.get("package_name")
                  or pkg.get("key")
                  or pkg.get("name")
              )
              version = pkg.get("installed_version")
              if not version:
                  version = "0"

              if not name:
                  skipped += 1
                  return False

              key = name  # GitHub wants package name as key

              if key not in resolved:
                  resolved[key] = {
                      "package_url": f"pkg:pypi/{name}@{version}",
                      "relationship": "direct" if direct else "indirect",
                      "dependencies": set(),  # we'll convert to list later
                  }

              # walk dependencies safely
              for dep in node.get("dependencies") or []:
                  if not isinstance(dep, dict):
                      continue
                  dep_pkg = dep.get("package")
                  if not dep_pkg:
                      continue
                  dep_name = (
                      dep_pkg.get("package_name")
                      or dep_pkg.get("key")
                      or dep_pkg.get("name")
                  )
                  if not dep_name:
                      continue

                  resolved[key]["dependencies"].add(dep_name)
                  add_node(dep, direct=False)

              return True

          # 2) process all top-level nodes
          for entry in raw:
              ok = add_node(entry, direct=True)
              if not ok:
                  skipped += 1

          # 3) turn sets → lists for GitHub
          for data in resolved.values():
              if isinstance(data.get("dependencies"), set):
                  data["dependencies"] = list(data["dependencies"])

          # 4) build snapshot
          snapshot = {
              "version": 0,
              "job": {
                  "id": os.environ.get("GITHUB_RUN_ID", "dependency-submission"),
                  "correlator": "python-deps"
              },
              "sha": os.environ.get("GITHUB_SHA", ""),
              "ref": os.environ.get("GITHUB_REF", "refs/heads/main"),
              "detector": {
                  "name": "obsidian-agent-python-deps",
                  "version": "1.0.0",
                  "url": f"https://github.com/{os.environ.get('GITHUB_REPOSITORY','')}"
              },
              "metadata": {
                  "scanned": datetime.now(timezone.utc).isoformat(),
                  "skipped_nodes": skipped,
              },
              "manifests": {
                  "requirements.txt": {
                      "name": "requirements.txt",
                      "file": {
                          "source_location": "requirements.txt"
                      },
                      "resolved": resolved
                  }
              }
          }

          with open("snapshot.json", "w") as f:
              json.dump(snapshot, f, indent=2)

          print(f"✅ built snapshot.json with {len(resolved)} packages")
          if skipped:
              print(f"⚠️ skipped {skipped} pipdeptree node(s) without 'package'")
          EOF

      - name: Submit dependency snapshot via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Submitting snapshot.json to GitHub dependency graph…"
          set -e
          RESPONSE_FILE=$(mktemp)
          STATUS_CODE=$(curl -sS -w "%{http_code}" -o "$RESPONSE_FILE" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/dependency-graph/snapshots" \
            --data-binary @snapshot.json)

          echo "GitHub API status: $STATUS_CODE"
          cat "$RESPONSE_FILE" || true

          if [ "$STATUS_CODE" = "201" ] || [ "$STATUS_CODE" = "200" ]; then
            echo "✅ Snapshot submitted successfully."
            exit 0
          fi

          if [ "$STATUS_CODE" = "403" ]; then
            echo "⚠️ 403: resource not accessible by integration. This GitHub token cannot write dependency snapshots."
            echo "    This is expected in orgs without dependency submission enabled for Actions."
            # don't fail CI for this case
            exit 0
          fi

          echo "❌ Unexpected error submitting snapshot (status $STATUS_CODE)"
          exit 1
